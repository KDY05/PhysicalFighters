name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - uses: gradle/actions/setup-gradle@v4

      - name: Extract version info
        id: version
        run: |
          BASE_VERSION=$(grep -oP "version\s*=\s*'\K[^']+" build.gradle)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)

          if [[ "$BASE_VERSION" == *-SNAPSHOT ]]; then
            RELEASE_VERSION="${BASE_VERSION}+${COMMIT_COUNT}"
            TAG="${RELEASE_VERSION}"
            IS_PRERELEASE=true
          else
            RELEASE_VERSION="${BASE_VERSION}"
            TAG="${RELEASE_VERSION}"
            IS_PRERELEASE=false
          fi

          echo "base_version=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "release_version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "commit_count=$COMMIT_COUNT" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Build
        run: chmod +x gradlew && ./gradlew clean build

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.release_version }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          generate_release_notes: true
          files: plugin/build/libs/PhysicalFighters-*.jar

      - name: Update snapshot release
        if: steps.version.outputs.is_prerelease == 'true'
        run: gh release delete snapshot --yes 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create snapshot release
        if: steps.version.outputs.is_prerelease == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: snapshot
          name: Latest Snapshot (${{ steps.version.outputs.release_version }})
          prerelease: true
          files: plugin/build/libs/PhysicalFighters-*.jar
          body: |
            Latest snapshot build: `${{ steps.version.outputs.release_version }}` (${{ steps.version.outputs.short_sha }})

            This release is automatically updated with the latest snapshot build.
            For all snapshot versions, see the [releases page](https://github.com/${{ github.repository }}/releases).
